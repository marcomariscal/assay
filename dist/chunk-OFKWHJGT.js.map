{"version":3,"sources":["../src/data/etherscan.ts","../src/core/scorer.ts","../src/core/analyzer.ts"],"sourcesContent":["/**\n * Contract Data Fetching\n * Uses Blockscout (free, no key) as primary source\n */\n\nimport type { Chain } from \"../core/types.js\";\nimport type { ContractInfo } from \"../core/scorer.js\";\n\nconst BLOCKSCOUT_URLS: Record<Chain, string> = {\n\tethereum: \"https://eth.blockscout.com/api/v2\",\n\tbase: \"https://base.blockscout.com/api/v2\",\n\tarbitrum: \"https://arbitrum.blockscout.com/api/v2\",\n\toptimism: \"https://optimism.blockscout.com/api/v2\",\n\tpolygon: \"https://polygon.blockscout.com/api/v2\",\n};\n\ninterface BlockscoutContract {\n\tis_verified?: boolean;\n\tis_partially_verified?: boolean;\n\tname?: string;\n\tsource_code?: string;\n\tverified_at?: string;\n\tcreation_status?: string;\n}\n\ninterface BlockscoutAddress {\n\tis_contract?: boolean;\n\tcreation_tx_hash?: string;\n}\n\n/**\n * Fetch contract info from Blockscout\n */\nexport async function getContractInfo(\n\taddress: string,\n\tchain: Chain,\n): Promise<ContractInfo> {\n\tconst baseUrl = BLOCKSCOUT_URLS[chain];\n\n\t// Fetch contract verification info\n\tconst contractData = await fetchContractData(baseUrl, address);\n\n\t// Fetch address info for creation time\n\tconst addressData = await fetchAddressData(baseUrl, address);\n\n\t// Calculate age if we have creation tx\n\tlet ageDays: number | null = null;\n\tif (addressData.creation_tx_hash) {\n\t\tageDays = await fetchContractAge(baseUrl, addressData.creation_tx_hash);\n\t}\n\n\t// Check for proxy pattern in source\n\tconst isProxy = contractData.source_code\n\t\t? /delegatecall|Proxy|implementation/i.test(contractData.source_code)\n\t\t: false;\n\n\t// Check for selfdestruct\n\tconst hasSelfDestruct = contractData.source_code\n\t\t? /selfdestruct|suicide/i.test(contractData.source_code)\n\t\t: false;\n\n\treturn {\n\t\tverified: contractData.is_verified || contractData.is_partially_verified || false,\n\t\tsourceAvailable: Boolean(contractData.source_code),\n\t\tcontractName: contractData.name,\n\t\tageDays,\n\t\ttxCount: null, // TODO: fetch tx count\n\t\tisProxy,\n\t\tisUpgradeable: isProxy,\n\t\thasSelfDestruct,\n\t\tprotocol: undefined, // TODO: match known protocols\n\t};\n}\n\nasync function fetchContractData(\n\tbaseUrl: string,\n\taddress: string,\n): Promise<BlockscoutContract> {\n\ttry {\n\t\tconst url = `${baseUrl}/smart-contracts/${address}`;\n\t\tconst res = await fetch(url);\n\n\t\tif (!res.ok) {\n\t\t\treturn {};\n\t\t}\n\n\t\treturn (await res.json()) as BlockscoutContract;\n\t} catch {\n\t\treturn {};\n\t}\n}\n\nasync function fetchAddressData(\n\tbaseUrl: string,\n\taddress: string,\n): Promise<BlockscoutAddress> {\n\ttry {\n\t\tconst url = `${baseUrl}/addresses/${address}`;\n\t\tconst res = await fetch(url);\n\n\t\tif (!res.ok) {\n\t\t\treturn {};\n\t\t}\n\n\t\treturn (await res.json()) as BlockscoutAddress;\n\t} catch {\n\t\treturn {};\n\t}\n}\n\nasync function fetchContractAge(\n\tbaseUrl: string,\n\ttxHash: string,\n): Promise<number | null> {\n\ttry {\n\t\tconst url = `${baseUrl}/transactions/${txHash}`;\n\t\tconst res = await fetch(url);\n\n\t\tif (!res.ok) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst data = (await res.json()) as { timestamp?: string };\n\n\t\tif (!data.timestamp) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst createdAt = new Date(data.timestamp).getTime();\n\t\tconst now = Date.now();\n\t\tconst ageDays = Math.floor((now - createdAt) / (1000 * 60 * 60 * 24));\n\n\t\treturn ageDays;\n\t} catch {\n\t\treturn null;\n\t}\n}\n","/**\n * Risk Scoring Logic\n */\n\nimport type { RiskLevel } from \"./types.js\";\n\nexport interface ContractInfo {\n\tverified: boolean;\n\tsourceAvailable: boolean;\n\tcontractName?: string;\n\tageDays: number | null;\n\ttxCount: number | null;\n\tisProxy: boolean;\n\tisUpgradeable: boolean;\n\thasSelfDestruct: boolean;\n\tprotocol?: string;\n}\n\nexport interface RiskResult {\n\tscore: number;\n\treasons: string[];\n}\n\n/**\n * Calculate risk score from contract info\n * Higher score = higher risk\n */\nexport function calculateRiskScore(info: ContractInfo): RiskResult {\n\tlet score = 0;\n\tconst reasons: string[] = [];\n\n\t// Unverified source (+40)\n\tif (!info.verified) {\n\t\tscore += 40;\n\t\treasons.push(\"‚ùå Unverified source code\");\n\t} else {\n\t\treasons.push(\"‚úì Source code verified\");\n\t}\n\n\t// Contract age\n\tif (info.ageDays !== null) {\n\t\tif (info.ageDays < 7) {\n\t\t\tscore += 30;\n\t\t\treasons.push(`‚ö†Ô∏è Very new contract (${info.ageDays} days old)`);\n\t\t} else if (info.ageDays < 30) {\n\t\t\tscore += 15;\n\t\t\treasons.push(`‚ö†Ô∏è New contract (${info.ageDays} days old)`);\n\t\t} else if (info.ageDays < 90) {\n\t\t\tscore += 5;\n\t\t\treasons.push(`‚úì Contract age: ${info.ageDays} days`);\n\t\t} else {\n\t\t\treasons.push(`‚úì Established contract (${info.ageDays} days old)`);\n\t\t}\n\t} else {\n\t\tscore += 10;\n\t\treasons.push(\"‚ö†Ô∏è Could not determine contract age\");\n\t}\n\n\t// Transaction count\n\tif (info.txCount !== null) {\n\t\tif (info.txCount < 10) {\n\t\t\tscore += 20;\n\t\t\treasons.push(`‚ö†Ô∏è Very low activity (${info.txCount} txs)`);\n\t\t} else if (info.txCount < 100) {\n\t\t\tscore += 10;\n\t\t\treasons.push(`‚ö†Ô∏è Low activity (${info.txCount} txs)`);\n\t\t} else if (info.txCount < 1000) {\n\t\t\treasons.push(`‚úì Moderate activity (${info.txCount} txs)`);\n\t\t} else {\n\t\t\treasons.push(`‚úì High activity (${info.txCount.toLocaleString()} txs)`);\n\t\t}\n\t}\n\n\t// Proxy/upgradeable (+15)\n\tif (info.isProxy || info.isUpgradeable) {\n\t\tscore += 15;\n\t\treasons.push(\"‚ö†Ô∏è Proxy/upgradeable contract\");\n\t}\n\n\t// Self-destruct (+20)\n\tif (info.hasSelfDestruct) {\n\t\tscore += 20;\n\t\treasons.push(\"‚ùå Contains selfdestruct\");\n\t}\n\n\t// Known protocol (-20)\n\tif (info.protocol) {\n\t\tscore = Math.max(0, score - 20);\n\t\treasons.push(`‚úì Known protocol: ${info.protocol}`);\n\t}\n\n\treturn { score, reasons };\n}\n\n/**\n * Convert numeric score to risk level\n */\nexport function scoreToLevel(score: number): RiskLevel {\n\tif (score <= 20) return \"low\";\n\tif (score <= 40) return \"medium\";\n\tif (score <= 60) return \"high\";\n\treturn \"critical\";\n}\n","/**\n * Contract Analyzer\n * Fetches contract info and produces risk analysis\n */\n\nimport type { Chain, ContractAnalysis, RiskLevel } from \"./types.js\";\nimport { getContractInfo } from \"../data/etherscan.js\";\nimport { calculateRiskScore, scoreToLevel } from \"./scorer.js\";\n\nexport interface AnalyzeOptions {\n\tchain: Chain;\n\tskipSimulation?: boolean;\n}\n\n/**\n * Analyze a contract for risk factors\n */\nexport async function analyzeContract(\n\taddress: string,\n\toptions: AnalyzeOptions,\n): Promise<ContractAnalysis> {\n\tconst { chain } = options;\n\n\t// Fetch contract info from block explorer\n\tconst info = await getContractInfo(address, chain);\n\n\t// Calculate risk\n\tconst { score, reasons } = calculateRiskScore(info);\n\tconst riskLevel = scoreToLevel(score);\n\n\treturn {\n\t\taddress,\n\t\tchain,\n\t\tverified: info.verified,\n\t\tsourceAvailable: info.sourceAvailable,\n\t\tcontractName: info.contractName,\n\t\tageDays: info.ageDays,\n\t\ttxCount: info.txCount,\n\t\tuniqueUsers: null, // TODO: requires more API calls\n\t\tisProxy: info.isProxy,\n\t\tisUpgradeable: info.isUpgradeable,\n\t\thasSelfDestruct: info.hasSelfDestruct,\n\t\tprotocol: info.protocol,\n\t\tauditStatus: \"unknown\", // TODO: integrate audit DB\n\t\tknownIssues: [], // TODO: integrate CVE/exploit DB\n\t\triskLevel,\n\t\triskScore: score,\n\t\triskReasons: reasons,\n\t};\n}\n\n/**\n * Quick check if this is first interaction with a contract\n */\nexport async function isFirstInteraction(\n\t_userAddress: string,\n\t_contractAddress: string,\n\t_chain: Chain,\n): Promise<boolean> {\n\t// TODO: Check user's tx history with this contract\n\t// For now, assume first interaction (safer default)\n\treturn true;\n}\n\n/**\n * Format analysis for display\n */\nexport function formatAnalysis(analysis: ContractAnalysis): string {\n\tconst icon = {\n\t\tlow: \"‚úÖ\",\n\t\tmedium: \"‚ö†Ô∏è\",\n\t\thigh: \"üî∂\",\n\t\tcritical: \"üö®\",\n\t}[analysis.riskLevel];\n\n\tconst lines = [\n\t\t`${icon} Contract Risk: ${analysis.riskLevel.toUpperCase()} (${analysis.riskScore})`,\n\t\t`   Address: ${analysis.address}`,\n\t\t`   Chain: ${analysis.chain}`,\n\t\t\"\",\n\t];\n\n\tif (analysis.contractName) {\n\t\tlines.push(`   Name: ${analysis.contractName}`);\n\t}\n\n\tif (analysis.protocol) {\n\t\tlines.push(`   Protocol: ${analysis.protocol}`);\n\t}\n\n\tlines.push(\"\");\n\tlines.push(\"   Risk Factors:\");\n\n\tfor (const reason of analysis.riskReasons) {\n\t\tconst prefix = reason.startsWith(\"‚úì\") ? \"   \" : \"   \";\n\t\tlines.push(`${prefix}${reason}`);\n\t}\n\n\treturn lines.join(\"\\n\");\n}\n"],"mappings":"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","names":[]}